#!/bin/bash

source _common.sh
source /usr/share/yunohost/helpers

hook_extra_conf_dir="/etc/yunohost/hooks.d/post_iptable_rules"
set__ip_prometheus_server() {
    if [ "$ip_prometheus_server" == "127.0.0.1" ]
    then
       yunohost firewall reload --debug
       ynh_print_info "Node exporter now listen local server Prometheus"
    else
        yunohost firewall reload --debug
        ynh_print_info "Node exporter now listen external server Prometheus"
    fi
    ynh_app_setting_set --key=ip_prometheus_server --value="$ip_prometheus_server"
}

set__ip_yunohost_server() {
    if [ "$ip_yunohost_server" eq "O" ]
    then
       # value IP local to listen for service
       ynh_app_setting_set --app="$app" --key="ip_yunohost_server" value="127.0.0.1"
       ynh_systemctl --service="node_exporter" --action=restart
    else
        # value IP server external to listen for service
        ynh_app_setting_set --app="$app" --key="ip_yunohost_server" value="$(curl -s https://ip.yunohost.org/)"
        ynh_systemctl --service="node_exporter" --action=restart
    fi
     ynh_app_setting_set --key=ip_yunohost_server --value="$ip_yunohost_server"
}

#ynh_app_config_run $1